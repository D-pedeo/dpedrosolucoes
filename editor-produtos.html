<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Produtos - D.Pedro Soluções</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            padding-top: 20px;
        }
        
        .header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
        }
        
        .logo {
            height: 50px;
            margin-right: 15px;
        }
        
        .product-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 2rem;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .product-image {
            position: relative;
            height: 200px;
            overflow: hidden;
        }
        
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .stats-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stats-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            padding: 1rem 1.5rem;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(400px);
            transition: transform 0.3s ease-in-out;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-left: 4px solid var(--success);
        }
        
        .notification.error {
            border-left: 4px solid var(--accent);
        }
        
        .notification.info {
            border-left: 4px solid var(--primary);
        }
    </style>
</head>
<body>
    <!-- Header com Logo -->
    <div class="header">
        <div class="container">
            <div class="logo-container">
                <a href="DPS.html">
                    <img src="https://i.postimg.cc/fks90nbK/DPS-ICO.jpg" alt="D.Pedro Soluções" class="logo">
                </a>
                <h1 class="h3 mb-0">Editor de Produtos - D.Pedro Soluções</h1>
                <div class="ms-auto">
                    <a href="loja-virtual.html" class="btn btn-outline-primary me-2">
                        <i class="fas fa-store"></i> Voltar para Loja
                    </a>
                    <a href="DPS.html" class="btn btn-primary">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-8">
                <div class="product-card">
                    <div class="card-header bg-white">
                        <h4 class="mb-0">Gerenciar Produtos</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="productsTable">
                                <thead>
                                    <tr>
                                        <th>Imagem</th>
                                        <th>Nome</th>
                                        <th>Categoria</th>
                                        <th>Preço</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <!-- Produtos serão carregados aqui -->
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <button class="btn btn-success" id="addProductBtn">
                                    <i class="fas fa-plus"></i> Adicionar Produto
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-outline-secondary" id="exportProductsBtn">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                                <button class="btn btn-outline-primary" id="syncProductsBtn">
                                    <i class="fas fa-sync"></i> Sincronizar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="stats-card">
                    <h5>Estatísticas da Loja</h5>
                    <div class="row mt-4">
                        <div class="col-6 mb-3">
                            <div class="stats-value" id="totalProducts">0</div>
                            <div class="stats-label">Total de Produtos</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="stats-value" id="totalCategories">0</div>
                            <div class="stats-label">Categorias</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="stats-value" id="productsWithDiscount">0</div>
                            <div class="stats-label">Produtos em Promoção</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="stats-value" id="averagePrice">0 AOA</div>
                            <div class="stats-label">Preço Médio</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <h5>Atividades Recentes</h5>
                    <div id="recentActivities">
                        <!-- Atividades serão carregadas aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Produto -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Adicionar Novo Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nome do Produto *</label>
                                    <input type="text" class="form-control" id="productName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Categoria *</label>
                                    <select class="form-control" id="productCategory" required>
                                        <option value="">Selecione...</option>
                                        <option value="materialescolar">Material Escolar</option>
                                        <option value="material_escritorio">Material de Escritório</option>
                                        <option value="materialeletrico">Material Elétrico</option>
                                        <option value="software">Software</option>
                                        <option value="hardware">Hardware</option>
                                        <option value="security">Segurança</option>
                                        <option value="network">Rede</option>
                                        <option value="cloud">Cloud</option>
                                        <option value="consulting">Consultoria</option>
                                        <option value="training">Treinamento</option>
                                        <option value="services">Serviços</option>
                                        <option value="telefone">Telefone</option>
                                        <option value="acessorios">Acessórios de Telefone</option>
                                        <option value="impressora">Impressora</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Preço (AOA) *</label>
                                    <input type="number" class="form-control" id="productPrice" required min="0" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Preço Original (AOA)</label>
                                    <input type="number" class="form-control" id="productOriginalPrice" min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Avaliação (0-5)</label>
                                    <input type="number" class="form-control" id="productRating" min="0" max="5" step="0.1" value="4.0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Número de Avaliações</label>
                                    <input type="number" class="form-control" id="productReviews" min="0" value="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">URL da Imagem</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="productImage">
                                <button class="btn btn-outline-secondary" type="button" id="searchImageBtn">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Descrição</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Termos de Busca (separados por vírgula)</label>
                            <input type="text" class="form-control" id="productSearchTerms" placeholder="ex: notebook, school, education">
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="productBadge">
                                <label class="form-check-label" for="productBadge">
                                    Destacar produto (badge)
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3" id="badgeTypeContainer" style="display: none;">
                            <label class="form-label">Tipo de Badge</label>
                            <select class="form-control" id="productBadgeType">
                                <option value="sale">Promoção</option>
                                <option value="new">Novo</option>
                                <option value="popular">Popular</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">Salvar Produto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notificação -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle text-success"></i>
        <div>
            <div class="fw-bold" id="notificationTitle">Sucesso</div>
            <div id="notificationMessage">Operação realizada com sucesso</div>
        </div>
        <button class="btn-close" id="closeNotification"></button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sistema de Gerenciamento de Produtos
        class ProductManager {
            constructor() {
                this.products = JSON.parse(localStorage.getItem('dps_products')) || [];
                this.currentId = Math.max(0, ...this.products.map(p => p.id)) + 1;
                this.loadProductsFromLoja();
                this.init();
            }
            
            init() {
                this.renderProductsTable();
                this.updateStats();
                this.setupEventListeners();
            }
            
            // Carregar produtos da loja virtual se disponíveis
            loadProductsFromLoja() {
                try {
                    // Tentar obter produtos da loja virtual
                    const lojaProducts = window.products || [];
                    if (lojaProducts.length > 0 && this.products.length === 0) {
                        this.products = [...lojaProducts];
                        this.currentId = Math.max(...this.products.map(p => p.id)) + 1;
                        this.saveToLocalStorage();
                    }
                } catch (error) {
                    console.error('Erro ao carregar produtos da loja:', error);
                }
            }
            
            // Salvar produtos no localStorage
            saveToLocalStorage() {
                localStorage.setItem('dps_products', JSON.stringify(this.products));
                // Enviar dados para DPS.html
                this.sendDataToDPS();
            }
            
            // Enviar dados para DPS.html
            sendDataToDPS() {
                const stats = this.calculateStats();
                const activity = {
                    type: 'products_updated',
                    timestamp: new Date().toISOString(),
                    data: {
                        totalProducts: stats.totalProducts,
                        totalCategories: stats.totalCategories,
                        productsWithDiscount: stats.productsWithDiscount,
                        averagePrice: stats.averagePrice
                    }
                };
                
                // Salvar no localStorage para DPS.html acessar
                localStorage.setItem('dps_loja_stats', JSON.stringify(stats));
                localStorage.setItem('dps_loja_activity', JSON.stringify(activity));
                
                // Disparar evento personalizado
                window.dispatchEvent(new CustomEvent('dpsLojaDataUpdated', {
                    detail: { stats, activity }
                }));
            }
            
            // Calcular estatísticas
            calculateStats() {
                const totalProducts = this.products.length;
                const categories = [...new Set(this.products.map(p => p.category))];
                const productsWithDiscount = this.products.filter(p => p.originalPrice).length;
                const totalPrice = this.products.reduce((sum, p) => sum + p.price, 0);
                const averagePrice = totalProducts > 0 ? Math.round(totalPrice / totalProducts) : 0;
                
                return {
                    totalProducts,
                    totalCategories: categories.length,
                    productsWithDiscount,
                    averagePrice
                };
            }
            
            // Atualizar estatísticas na UI
            updateStats() {
                const stats = this.calculateStats();
                
                document.getElementById('totalProducts').textContent = stats.totalProducts;
                document.getElementById('totalCategories').textContent = stats.totalCategories;
                document.getElementById('productsWithDiscount').textContent = stats.productsWithDiscount;
                document.getElementById('averagePrice').textContent = stats.averagePrice.toLocaleString('pt-AO') + ' AOA';
            }
            
            // Renderizar tabela de produtos
            renderProductsTable() {
                const tbody = document.getElementById('productsTableBody');
                tbody.innerHTML = '';
                
                this.products.forEach(product => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <img src="${product.image}" alt="${product.name}" 
                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;"
                                 onerror="this.src='https://via.placeholder.com/50?text=Imagem'">
                        </td>
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>${this.formatPrice(product.price)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="productManager.editProduct(${product.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="productManager.deleteProduct(${product.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                this.updateStats();
            }
            
            // Formatar preço
            formatPrice(price) {
                return new Intl.NumberFormat('pt-AO', { style: 'currency', currency: 'AOA' }).format(price);
            }
            
            // Adicionar produto
            addProduct(productData) {
                const product = {
                    id: this.currentId++,
                    name: productData.name,
                    category: productData.category,
                    price: parseFloat(productData.price),
                    originalPrice: productData.originalPrice ? parseFloat(productData.originalPrice) : undefined,
                    image: productData.image || 'https://via.placeholder.com/300x200?text=Sem+Imagem',
                    rating: parseFloat(productData.rating) || 4.0,
                    reviews: parseInt(productData.reviews) || 0,
                    badge: productData.badge ? productData.badgeType : undefined,
                    description: productData.description,
                    searchTerms: productData.searchTerms ? productData.searchTerms.split(',').map(term => term.trim()) : []
                };
                
                this.products.push(product);
                this.saveToLocalStorage();
                this.renderProductsTable();
                
                this.showNotification('Sucesso', 'Produto adicionado com sucesso!', 'success');
                return product;
            }
            
            // Editar produto
            editProduct(id) {
                const product = this.products.find(p => p.id === id);
                if (product) {
                    // Preencher formulário
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productCategory').value = product.category;
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productOriginalPrice').value = product.originalPrice || '';
                    document.getElementById('productRating').value = product.rating;
                    document.getElementById('productReviews').value = product.reviews;
                    document.getElementById('productImage').value = product.image;
                    document.getElementById('productDescription').value = product.description || '';
                    document.getElementById('productSearchTerms').value = product.searchTerms ? product.searchTerms.join(', ') : '';
                    document.getElementById('productBadge').checked = !!product.badge;
                    document.getElementById('productBadgeType').value = product.badge || 'sale';
                    
                    if (product.badge) {
                        document.getElementById('badgeTypeContainer').style.display = 'block';
                    }
                    
                    // Alterar modal para modo edição
                    document.getElementById('productModalTitle').textContent = 'Editar Produto';
                    document.getElementById('saveProductBtn').textContent = 'Atualizar Produto';
                    document.getElementById('saveProductBtn').onclick = () => this.updateProduct(id);
                    
                    const modal = new bootstrap.Modal(document.getElementById('productModal'));
                    modal.show();
                }
            }
            
            // Atualizar produto
            updateProduct(id) {
                const productIndex = this.products.findIndex(p => p.id === id);
                if (productIndex !== -1) {
                    this.products[productIndex] = {
                        ...this.products[productIndex],
                        name: document.getElementById('productName').value,
                        category: document.getElementById('productCategory').value,
                        price: parseFloat(document.getElementById('productPrice').value),
                        originalPrice: document.getElementById('productOriginalPrice').value ? 
                                      parseFloat(document.getElementById('productOriginalPrice').value) : undefined,
                        image: document.getElementById('productImage').value,
                        rating: parseFloat(document.getElementById('productRating').value),
                        reviews: parseInt(document.getElementById('productReviews').value),
                        badge: document.getElementById('productBadge').checked ? 
                              document.getElementById('productBadgeType').value : undefined,
                        description: document.getElementById('productDescription').value,
                        searchTerms: document.getElementById('productSearchTerms').value ? 
                                    document.getElementById('productSearchTerms').value.split(',').map(term => term.trim()) : []
                    };
                    
                    this.saveToLocalStorage();
                    this.renderProductsTable();
                    
                    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                    modal.hide();
                    
                    this.showNotification('Sucesso', 'Produto atualizado com sucesso!', 'success');
                }
            }
            
            // Excluir produto
            deleteProduct(id) {
                if (confirm('Tem certeza que deseja excluir este produto?')) {
                    this.products = this.products.filter(p => p.id !== id);
                    this.saveToLocalStorage();
                    this.renderProductsTable();
                    this.showNotification('Sucesso', 'Produto excluído com sucesso!', 'success');
                }
            }
            
            // Configurar event listeners
            setupEventListeners() {
                // Botão Adicionar Produto
                document.getElementById('addProductBtn').addEventListener('click', () => {
                    // Resetar formulário
                    document.getElementById('productForm').reset();
                    document.getElementById('productModalTitle').textContent = 'Adicionar Novo Produto';
                    document.getElementById('saveProductBtn').textContent = 'Salvar Produto';
                    document.getElementById('saveProductBtn').onclick = () => this.saveNewProduct();
                    document.getElementById('badgeTypeContainer').style.display = 'none';
                    
                    const modal = new bootstrap.Modal(document.getElementById('productModal'));
                    modal.show();
                });
                
                // Checkbox de badge
                document.getElementById('productBadge').addEventListener('change', function() {
                    document.getElementById('badgeTypeContainer').style.display = this.checked ? 'block' : 'none';
                });
                
                // Botão Salvar Produto
                document.getElementById('saveProductBtn').addEventListener('click', () => {
                    this.saveNewProduct();
                });
                
                // Botão Buscar Imagem
                document.getElementById('searchImageBtn').addEventListener('click', () => {
                    this.openImageSearch();
                });
                
                // Botão Sincronizar
                document.getElementById('syncProductsBtn').addEventListener('click', () => {
                    this.syncWithLoja();
                });
                
                // Botão Exportar
                document.getElementById('exportProductsBtn').addEventListener('click', () => {
                    this.exportProducts();
                });
                
                // Fechar notificação
                document.getElementById('closeNotification').addEventListener('click', () => {
                    this.hideNotification();
                });
            }
            
            // Salvar novo produto
            saveNewProduct() {
                const form = document.getElementById('productForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                const productData = {
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    price: document.getElementById('productPrice').value,
                    originalPrice: document.getElementById('productOriginalPrice').value,
                    image: document.getElementById('productImage').value,
                    rating: document.getElementById('productRating').value,
                    reviews: document.getElementById('productReviews').value,
                    badge: document.getElementById('productBadge').checked,
                    badgeType: document.getElementById('productBadgeType').value,
                    description: document.getElementById('productDescription').value,
                    searchTerms: document.getElementById('productSearchTerms').value
                };
                
                this.addProduct(productData);
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                modal.hide();
            }
            
            // Abrir busca de imagem
            openImageSearch() {
                // Em uma implementação real, isso abriria o modal de busca de imagens
                // Por enquanto, vamos apenas mostrar uma mensagem
                this.showNotification('Info', 'Funcionalidade de busca de imagens será implementada em breve', 'info');
            }
            
            // Sincronizar com a loja
            syncWithLoja() {
                try {
                    this.loadProductsFromLoja();
                    this.renderProductsTable();
                    this.showNotification('Sucesso', 'Produtos sincronizados com a loja!', 'success');
                } catch (error) {
                    this.showNotification('Erro', 'Falha ao sincronizar produtos', 'error');
                }
            }
            
            // Exportar produtos
            exportProducts() {
                const dataStr = JSON.stringify(this.products, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = 'produtos-dps.json';
                link.click();
                
                this.showNotification('Sucesso', 'Produtos exportados com sucesso!', 'success');
            }
            
            // Mostrar notificação
            showNotification(title, message, type = 'info') {
                const notification = document.getElementById('notification');
                const notificationTitle = document.getElementById('notificationTitle');
                const notificationMessage = document.getElementById('notificationMessage');
                
                notification.className = `notification ${type} show`;
                notificationTitle.textContent = title;
                notificationMessage.textContent = message;
                
                // Icone baseado no tipo
                const icon = notification.querySelector('i');
                icon.className = type === 'success' ? 'fas fa-check-circle text-success' : 
                                type === 'error' ? 'fas fa-exclamation-circle text-danger' : 
                                'fas fa-info-circle text-primary';
                
                // Auto-esconder após 5 segundos
                setTimeout(() => {
                    this.hideNotification();
                }, 5000);
                
                // Registrar atividade
                this.addActivity(`Notificação: ${title} - ${message}`);
            }
            
            // Esconder notificação
            hideNotification() {
                document.getElementById('notification').classList.remove('show');
            }
            
            // Adicionar atividade
            addActivity(message) {
                const activitiesContainer = document.getElementById('recentActivities');
                const activityElement = document.createElement('div');
                activityElement.className = 'activity-item mb-2 p-2 border-bottom';
                activityElement.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-circle text-success me-2" style="font-size: 0.5rem;"></i>
                        <div>
                            <div class="small">${message}</div>
                            <div class="text-muted" style="font-size: 0.7rem;">${new Date().toLocaleTimeString('pt-BR')}</div>
                        </div>
                    </div>
                `;
                
                activitiesContainer.prepend(activityElement);
                
                // Manter apenas as 5 atividades mais recentes
                const activities = activitiesContainer.querySelectorAll('.activity-item');
                if (activities.length > 5) {
                    activities[activities.length - 1].remove();
                }
            }
        }
        
        // Inicializar gerenciador de produtos quando a página carregar
        let productManager;
        document.addEventListener('DOMContentLoaded', function() {
            productManager = new ProductManager();
        });
    </script>
</body>
</html>